<div class="admin-dashboard container-fluid py-5" data-bs-theme="dark">
  <div class="row justify-content-center">
    <div class="col-12 col-xxl-10">
      <div class="page-heading d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
        <div>
          <p class="text-uppercase text-secondary fw-semibold small mb-1 letter-spacing">Visao administrativa</p>
          <h2 class="mb-0 text-light">Gestao de Registros</h2>
          <p class="text-secondary mb-0">Acompanhe e analise todos os registros do sistema em tempo real.</p>
        </div>
        <button class="btn btn-outline-info" (click)="loadRegisters()" [disabled]="isLoading()">
          <i class="bi bi-arrow-repeat me-2"></i>
          Atualizar
        </button>
      </div>

      @if (errorMessage()) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage() }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      }

      @if (isLoading()) {
        <div class="card border-0 shadow-lg bg-dark text-center text-secondary py-5 mb-4">
          <div class="spinner-border text-info mb-3" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="mb-0">Buscando registros e consolidando a visao administrativa.</p>
        </div>
      } @else {
        <section class="card border-0 shadow-lg bg-dark text-light mb-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-2">
              <div>
                <h5 class="mb-0 text-uppercase text-secondary small">Visao geral</h5>
                <h3 class="mb-0 text-light">Total de {{ totalRegisters }} registros</h3>
              </div>
              <span class="badge rounded-pill bg-info-subtle text-info-emphasis px-3 py-2">
                <i class="bi bi-database-fill me-2"></i>
                Fonte: /api/registers
              </span>
            </div>
            <div class="row g-3">
              @for (summary of statusSummary; track summary.key) {
                <div class="col-12 col-md-4">
                  <article class="status-card h-100 border rounded-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="d-flex align-items-center gap-2">
                        <i class="bi {{ summary.icon }} fs-4 fw-bold" [ngClass]="summary.accentClass"></i>
                        <div>
                          <p class="mb-0 text-uppercase text-secondary small letter-spacing">{{ summary.label }}</p>
                          <span class="h4 mb-0 text-light">{{ summary.count }}</span>
                        </div>
                      </div>
                    </div>
                    <div class="progress bg-secondary-subtle rounded-2" style="height: 6px;">
                      <div class="progress-bar" [ngClass]="summary.barClass" role="progressbar"
                           [style.width.%]="summary.percent"
                           [attr.aria-valuenow]="summary.percent"
                           aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="badge" [ngClass]="summary.badgeClass">
                      {{ summary.percent }}%
                    </span>
                  </article>
                </div>
              }
            </div>
          </div>
        </section>

        <section class="card border-0 shadow-lg bg-dark text-light mb-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-2">
              <div>
                <h5 class="mb-0 text-uppercase text-secondary small">Grafico por status</h5>
                <h3 class="mb-0 text-light">Distribuicao dos registros</h3>
              </div>
            </div>
            <div class="chart-wrapper">
              @for (summary of statusSummary; track summary.key) {
                <div class="chart-row">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-semibold" [ngClass]="summary.accentClass">{{ summary.label }}</span>
                    <span class="text-secondary small">{{ summary.count }} itens</span>
                  </div>
                  <div class="chart-bar bg-secondary-subtle">
                    <div class="chart-bar-fill" [ngClass]="summary.barClass" [style.width.%]="summary.percent"></div>
                  </div>
                </div>
              }
            </div>
          </div>
        </section>

        <section class="card border-0 shadow-lg bg-dark text-light">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-2">
              <div>
                <h5 class="mb-0 text-uppercase text-secondary small">Listagem detalhada</h5>
                <h3 class="mb-0 text-light">Registros por status</h3>
              </div>
            </div>

            @for (group of groupedRegisters; track group.key) {
              <div class="status-group mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge px-3 py-2" [ngClass]="statusBadgeClass(group.key)">{{ statusLabel(group.key) }}</span>
                    <span class="text-secondary small">{{ group.registers.length }} registros</span>
                  </div>
                </div>

                @if (group.registers.length === 0) {
                  <div class="empty-state text-secondary small border rounded-3 p-3">Nenhum registro classificado para este status.</div>
                } @else {
                  <div class="table-responsive">
                    <table class="table table-dark table-striped table-sm align-middle mb-0">
                      <thead>
                      <tr>
                         <th scope="col">Titulo</th>
                         <th scope="col">Descricao</th>
                        <th scope="col">Local</th>
                        <th scope="col">Escala</th>
                        <th scope="col">Status</th>
                        <th scope="col">Criado em</th>
                      </tr>
                      </thead>
                      <tbody>
                      @for (register of group.registers; track register.uid) {
                        <tr>
                          <td class="fw-semibold">{{ register.title }}</td>
                          <td class="text-secondary small">{{ register.body }}</td>
                          <td class="text-secondary small">{{ register.local || '-' }}</td>
                          @if (register.riskScale !== null && register.riskScale !== undefined) {
                            <td>{{ register.riskScale }}</td>
                          } @else {
                            <td>-</td>
                          }
                          <td>
                            <span class="badge" [ngClass]="statusBadgeClassForValue(register.status)">
                              {{ statusLabelForValue(register.status) }}
                            </span>
                          </td>
                          <td class="text-secondary small">
                            @let createdAt = resolveCreatedAt(register);
                            @if (createdAt) {
                              {{ createdAt | date: 'dd/MM/yyyy HH:mm' }}
                            } @else {
                              -
                            }
                          </td>
                        </tr>
                      }
                      </tbody>
                    </table>
                  </div>
                }
              </div>
              <br>
              <br>
            }
          </div>
        </section>
      }
    </div>
  </div>
</div>
